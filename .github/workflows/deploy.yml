name: Deploy finuniques.in React Build to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. pull latest source
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      # 2. Node env set
      - name: ğŸ›  Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. Install & Build React (CRA)
      # CI=false => warnings pe build fail na ho
      - name: ğŸ— Build React App
        run: |
          npm install --legacy-peer-deps
          CI=false npm run build

      # 4. Bundle only the final static site
      - name: ğŸ“¦ Create tar from build/
        run: |
          tar -czvf finuniques_build.tar.gz -C build .

      # 5. Upload tar.gz to EC2 (root login via SSH key)
      - name: ğŸš€ Upload artifact to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.AWS_SSH_HOST }}
          username: ${{ secrets.AWS_SSH_USER }}
          port: ${{ secrets.AWS_SSH_PORT }}
          key: ${{ secrets.AWS_SSH_KEY }}
          source: "finuniques_build.tar.gz"
          target: "/var/www/"

      # 6. SSH into EC2 â†’ backup old site â†’ replace with new build â†’ fix owner
      - name: ğŸ”„ Deploy on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_SSH_HOST }}
          username: ${{ secrets.AWS_SSH_USER }}
          port: ${{ secrets.AWS_SSH_PORT }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            set -e

            WEBROOT=/var/www/finuniques.in
            BACKUP_DIR=/var/www/finuniques_backups
            TARBALL=/var/www/finuniques_build.tar.gz

            echo "ğŸ“‚ Making backup dir if not exists"
            mkdir -p $BACKUP_DIR

            echo "ğŸ—„ Taking timestamped backup of current live site"
            timestamp=$(date +%Y%m%d_%H%M%S)
            if [ -d "$WEBROOT" ]; then
              cp -r $WEBROOT $BACKUP_DIR/finuniques_$timestamp || true
            fi

            echo "ğŸ§¼ Cleaning old files from live webroot"
            rm -rf $WEBROOT/*
            
            echo "ğŸ“¦ Extracting new build to live webroot"
            tar -xzvf $TARBALL -C $WEBROOT

            echo "ğŸ§¹ Removing uploaded tar"
            rm $TARBALL

            echo "ğŸ” Setting correct ownership for nginx"
            chown -R nginx:nginx $WEBROOT

            echo "âœ… Deploy complete for finuniques.in"
